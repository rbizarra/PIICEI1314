<!DOCTYPE html>
<html>
<head>
<title>Geoserver Layers using OpenLayers</title>
<!--<link rel="stylesheet" title="alternative" type="text/css" href="homepage_theme_2.css"/>
<link rel="shortcut icon" href="../resources/favicon.png">-->

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" type="text/css">
<link rel="stylesheet" href="http://openlayers.org/dev/examples/style.css" type="text/css">
<link type="text/css" href="OpenLayers/theme/default/style.css" rel="stylesheet">
<script src="OpenLayers/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>

<style>
    .customEditingToolbar {
        float: right;
        right: 0px;
        height: 30px;
    }

    .customEditingToolbar div {
        float: right;
        margin: 4px;
        width: 24px;
        height: 24px;
    }

    .olControlDrawFeaturePolygonItemInactive {
        background-image: url("OpenLayers/theme/default/img/draw_polygon_off.png");
        background-repeat: no-repeat;
    }

    .olControlDrawFeaturePolygonItemActive {
        background-image: url("OpenLayers/theme/default/img/draw_polygon_on.png");
        background-repeat: no-repeat;
    }

    .olControlDeleteFeatureItemActive {
        background-image: url(OpenLayers/theme/default/img/remove_point_on.png);
        background-repeat: no-repeat;
    }

    .olControlDeleteFeatureItemInactive {
        background-image: url(OpenLayers/theme/default/img/remove_point_off.png);
        background-repeat: no-repeat;
    }

    .olControlSaveFeatureItemActive {
        background-image: url(OpenLayers/theme/default/img/save_features_on.png);
        background-repeat: no-repeat;
    }

    .olControlSaveFeatureItemInactive {
        background-image: url(OpenLayers/theme/default/img/save_features_off.png);
        background-repeat: no-repeat;
    }

</style>

<script type="text/javascript">

var DeleteFeature = OpenLayers.Class(OpenLayers.Control, {
    initialize: function (layer, options) {
        OpenLayers.Control.prototype.initialize.apply(this, [options]);
        this.layer = layer;
        this.handler = new OpenLayers.Handler.Feature(
                this, layer, {click: this.clickFeature}
        );
    },
    clickFeature: function (feature) {
        // if feature doesn't have a fid, destroy it
        if (feature.fid == undefined) {
            this.layer.destroyFeatures([feature]);
        } else {
            feature.state = OpenLayers.State.DELETE;
            this.layer.events.triggerEvent("afterfeaturemodified",
                    {feature: feature});
            feature.renderIntent = "select";
            this.layer.drawFeature(feature);
        }
    },
    setMap: function (map) {
        this.handler.setMap(map);
        OpenLayers.Control.prototype.setMap.apply(this, arguments);
    },
    CLASS_NAME: "OpenLayers.Control.DeleteFeature"
});

function init() {

    // World Geodetic System 1984 projection
    var WGS84 = new OpenLayers.Projection("EPSG:4326");
    // WGS84 Google Mercator projection
    var WGS84_google_mercator = new OpenLayers.Projection("EPSG:900913");

    //Initialize the map
    //creates a new openlayers map in the <div> html element with id="map"
    var map = new OpenLayers.Map("map", {
        controls: [
            //allows the user pan ability
            new OpenLayers.Control.Navigation(),
            //displays the pan/zoom tools
            new OpenLayers.Control.PanZoom(),
            //displays a layer switcher
            new OpenLayers.Control.LayerSwitcher(),
            //displays the mouse position's coordinates in a
            //<div> html element with id="coordinates"
            new OpenLayers.Control.MousePosition(
                    {div: document.getElementById("coordinates")})
        ],

        //TODO: VERIFICAR ESTE BUG
        //PARA WMS: DESCOMENTAR A LINHA "PROJECTION"
        //PARA WFS: COMENTAR A LINHA "PROJECTION"

        // WGS84 Google Mercator projection
        //projection: WGS84_google_mercator,
        // World Geodetic System 1984 projection
        displayProjection: WGS84
    });

    // map extent -> initial coordinates
    var mapextent =
            new OpenLayers.Bounds(-110.51794, 17.63206, -79.58044, 52.42157).transform(WGS84, WGS84_google_mercator); //USA all
//                new OpenLayers.Bounds(-123.17341, 49.24343, -123.06183, 49.29899).transform(WGS84, WGS84_google_mercator);
//                new OpenLayers.Bounds(-74.14023, 40.62600, -73.79759, 40.88503).transform(WGS84, WGS84_google_mercator); //NY
//                new OpenLayers.Bounds(143.62000, -43.91327, 149.11316, -39.82493).transform(WGS84, WGS84_google_mercator); //Tasmania
//                new OpenLayers.Bounds(-144.75793, -9.37040, -57.04309, 61.39281).transform(WGS84, WGS84_google_mercator); //USA
//                new OpenLayers.Bounds(-9.27273, 38.5882, -9.10141, 38.72121).transform(WGS84, WGS84_google_mercator); //margem sul

    //base layers -> the different options of visualization
    var openstreetmap = new OpenLayers.Layer.OSM();

    var google_maps = new OpenLayers.Layer.Google(
            "Google Maps", {
                numZoomLevels: 20
            }
    );

    var google_satellite = new OpenLayers.Layer.Google(
            "Google Satellite", {
                type: google.maps.MapTypeId.SATELLITE,
                numZoomLevels: 20
            }
    );

    var aliasproj = new OpenLayers.Projection("EPSG:3857");
    openstreetmap.projection = google_maps.projection = google_satellite.projection = aliasproj;


    //***********************UNITED STATES*****************************

//            var wms = new OpenLayers.Layer.WMS('USA States',
//                    'http://localhost:9991/geoserver/topp/wms',
//                    {'layers': 'topp:states',
//                        isBaseLayer: false, 'transparent': true} //This part was required!
//            );

    var saveStrategy = new OpenLayers.Strategy.Save();

    var wfs_layer = new OpenLayers.Layer.Vector("USA States", {
        strategies: [new OpenLayers.Strategy.BBOX(), saveStrategy],
        protocol: new OpenLayers.Protocol.WFS({
            version: "1.1.0",
            url: "http://localhost:9991/geoserver/wfs",
            featurePrefix: "topp",
            featureType: "states",
            featureNS: "http://www.openplans.org/topp",
            geometryName: "the_geom",
            srsName: "EPSG:4326"
        })
        //renderers : renderer
    });
    wfs_layer.setMap(map);

    map.addLayers([openstreetmap, google_maps, google_satellite, wfs_layer]);


    //**********************************CONTROLO******************************************


    var panel = new OpenLayers.Control.Panel({
        displayClass: 'customEditingToolbar',
        allowDepress: true
    });

    var drawPoly = new OpenLayers.Control.DrawFeature(
            wfs_layer, OpenLayers.Handler.Polygon,
            {
                title: "Draw Polygon",
                displayClass: "olControlDrawFeaturePolygon",
                multi: true
            }
    );

    var del = new DeleteFeature(wfs_layer, {title: "Delete Feature"});

    var save = new OpenLayers.Control.Button({
        title: "Save Changes",
        trigger: function () {
            saveStrategy.save();
        },
        displayClass: "olControlSaveFeatures"
    });

    panel.addControls([save, del, drawPoly]);
    map.addControl(panel);
    map.zoomToExtent(mapextent, true);


    //*****************************TESTES********************************************

    //            var wfs_layer = new OpenLayers.Layer.Vector("New York Roads", {
//                strategies: [new OpenLayers.Strategy.Fixed()],
//                protocol: new OpenLayers.Protocol.WFS({
//                    version: "1.1.0",
//                    url: "http://localhost:9991/geoserver/wfs",
//                    featurePrefix: "myc_roads",
//                    featureType: "nyc_roads",
//                    featureNS: "http://opengeo.org/nyc_roads",
//                    geometryName: "the_geom",
//                    srsName: "EPSG:4326"
//                })
//                //renderers : renderer
//            });

    //display layer using WMS
//            var wms = new OpenLayers.Layer.WMS('New York Roads',
//                    'http://localhost:9991/geoserver/nyc_roads/wms',
//                    {'layers': 'nyc_roads:nyc_roads',
//                        isBaseLayer: false, 'transparent': true} //This part was required!
//            );


    //***********************TASMANIA*****************************
    //WMS funciona, WFS também
    //Caso queira mostrar WMS, alterar definições na inicialização do MAPA!!

//            var wms1 = new OpenLayers.Layer.WMS('Tasmania - Water',
//                    'http://localhost:9991/geoserver/topp/wms',
//                    {'layers': 'topp:tasmania_water_bodies',
//                        isBaseLayer: false, 'transparent': true} //This part was required!
//            );
//
//            var wms2 = new OpenLayers.Layer.WMS('Tasmania - Roads',
//                    'http://localhost:9991/geoserver/topp/wms',
//                    {'layers': 'topp:tasmania_roads',
//                        isBaseLayer: false, 'transparent': true} //This part was required!
//            );

//            var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
//            renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;

    //Obter a layer usando um pedido GET - não usar, pois não permite guardar alteraçoes
//            var wfs_options = {
//                url: "http://localhost:9991/geoserver/topp/ows",
//                params: {
//                    service: "WFS",
//                    version: "1.0.0",
//                    request: "GetFeature",
//                    typeName: "topp:tasmania_roads"
//                },
//                format: new OpenLayers.Format.GML({
//                    featureNS: "http://www.openplans.org/topp",
//                    geometryName: "the_geom",
//                    isBaseLayer: false,
//                    transparent: true,
//                    srsName: "EPSG:4326"
//                })
//            };
//
//            var wfs_layer = new OpenLayers.Layer.Vector('WFS', {
//                strategies: [new OpenLayers.Strategy.Fixed()],
//                visibility: true,
//                protocol: new OpenLayers.Protocol.HTTP(wfs_options)
//            });

    //Obter layer usando um pedido POST
//            var wfs_layer = new OpenLayers.Layer.Vector("WFS Tasmania Water", {
//                strategies: [new OpenLayers.Strategy.Fixed()],
//                protocol: new OpenLayers.Protocol.WFS({
//                    version: "1.1.0",
//                    url: "http://localhost:9991/geoserver/wfs",
//                    featurePrefix: "topp",
//                    featureType: "tasmania_water_bodies",
//                    featureNS: "http://www.openplans.org/topp",
//                    geometryName: "the_geom",
//                    srsName: "EPSG:4326",
//                    visibility: true
//                })
//                //renderers : renderer
//            });
//            wfs_layer.setMap(map);


//    wms1.setMap(map);
//    wms2.setMap(map);
//    map.addLayers([openstreetmap, google_maps, google_satellite, wfs_layer, wms1, wms2]);
//    map.addLayers([openstreetmap, google_maps, google_satellite, wms]);
//    map.zoomToExtent(mapextent);

}
;

</script>

</head>
<body onload="init()">
<div id="map" style="width:500px; height:500px;"></div>
<div id="coordinates"></div>
<div id="nodelist"></div>
</body>
</html>